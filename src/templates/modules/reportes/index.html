{% extends "base.html" %}
{% block main %}
    <h2>Reporte de consultas</h2>

    <select id="selectForReport">
        <option value="" selected disabled hidden> Seleccione una opci&oacute;n</option>
        <option value="motivo">Por motivo</option>
        <option value="genero">Por genero</option>
        <option value="localidad">Por localidad</option>
    </select>

    <div class="container">
        <div class="row">
            <div class="col-sm">
                <div id="container" style="width: 90%; height: 500px"></div>
            </div>
        </div>
    </div>
    <!--[if lt IE 9]>
    <script src="https://code.highcharts.com/modules/oldie.js"></script>
    <![endif]-->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>

    <script>

        $("#selectForReport").change(function () {
            var optionSelected = $(this).find("option:selected");
            var valueSelected = optionSelected.val();
            switch (valueSelected) {

                case 'motivo':
                    getDataForReports('/api/reportes/motivo');
                    break;
                case 'genero':
                    getDataForReports('/api/reportes/genero');
                    break;
                case 'localidad':
                    getDataForReports('/api/reportes/localidad');
                    break;
            }

        });


        function showReport(datos) {

            Highcharts.addEvent(Highcharts.Chart, 'render', function () {
                var table = this.dataTableDiv;
                if (table) {

                    // Apply styles inline because stylesheets are not passed to the exported SVG
                    styleTable(table);

                    // Add the table as the subtitle to make it part of the export
                    this.setTitle(null, {
                        text: table.outerHTML,
                        useHTML: true
                    });
                    if (table.parentNode) {
                        table.parentNode.removeChild(table);
                    }
                    delete this.dataTableDiv;
                }
            });

            setChartConfig(datos);
        }
        function setChartConfig(datos) {
            var chart = Highcharts.chart('container', {
                chart: {
                    type: 'pie'
                },
                title: {
                    text: ' ',
                },
                subtitle: {
                    text: null,
                    align: 'center'
                },
                legend: {
                    align: 'center',
                    layout: 'horizontal',
                },
                plotOptions: {
                    pie: {
                        size: '90%',
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: false
                        },
                        showInLegend: true
                    }
                },

                series: [{
                    name: 'cantidad',
                    data: datos
                }],
                exporting: {
                    showTable: true,
                    allowHTML: true,
                    dataLabels: {
                        enabled: false
                    },
                },

            });
        }
        function styleTable(table){

            Highcharts.css(table.querySelector('table'), {
                'border-collapse': 'collapse',
                'border-spacing': 0,
                'background': 'white',
                'min-width': '100%',
                'font-family': 'sans-serif',
                'font-size': '14px'
            });

            table.querySelectorAll('td, th, caption').forEach(function (elem) {
                Highcharts.css(elem, {
                    padding: '0.5em',
                });
            });

            Highcharts.css(table.querySelector('caption'), {
                'border-bottom': 'none',
                'font-size': '1.1em',
                'font-weight': 'bold'
            });

            table.querySelectorAll('caption, tr').forEach(function (elem, i) {
                if (i % 2) {
                    Highcharts.css(elem, {
                        background: '#f8f8f8'
                    });
                }
            });
        }
        function successGetReport(data) {
            showReport(data);
        }
        function errorGetReport(data) {
            console.log(data);
            console.log('error');
        }
        function getDataForReports(url) {
            $url = url;
            $data = [];
            getJson($url, $data, successGetReport, errorGetReport);
        }

    </script>
{% endblock %}