{% extends "base.html" %}
{% block main %}
  <h2>Reporte de consultas</h2>

  <div class="container">
    <div class="row">
      <div class="col-sm">
        <div id="container1" style="width: 90%; height: 500px"></div>
      </div>
      <div class="col-sm">
        <div id="container2" style="width: 90%; height: 500px"></div>
      </div>
      <div class="col-sm">
        <div id="container3" style="width: 90%; height: 500px"></div>
      </div>
    </div>
  </div>
  <!--[if lt IE 9]>
  <script src="https://code.highcharts.com/modules/oldie.js"></script>
  <![endif]-->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>

  <script>

      function showReport(datos, containerToDraw) {

          Highcharts.addEvent(Highcharts.Chart, 'render', function () {
              var table = this.dataTableDiv;
              if (table) {

                  // Apply styles inline because stylesheets are not passed to the exported SVG
                  styleTable(table);

                  // Add the table as the subtitle to make it part of the export
                  this.setTitle(null, {
                      text: table.outerHTML,
                      useHTML: true
                  });
                  if (table.parentNode) {
                      table.parentNode.removeChild(table);
                  }
                  delete this.dataTableDiv;
              }
          });

          setChartConfig(datos, containerToDraw);
      }

      function setChartConfig(datos, containerToDraw) {
          var chart = Highcharts.chart(containerToDraw, {
              chart: {
                  type: 'pie'
              },
              title: {
                  text: ' ',
              },
              subtitle: {
                  text: null,
                  align: 'center'
              },
              legend: {
                  align: 'center',
                  layout: 'horizontal',
              },
              plotOptions: {
                  pie: {
                      size: '90%',
                      allowPointSelect: true,
                      cursor: 'pointer',
                      dataLabels: {
                          enabled: false
                      },
                      showInLegend: true
                  }
              },

              series: [{
                  name: 'cantidad de consultas',
                  data: datos
              }],
              exporting: {
                  showTable: true,
                  allowHTML: true,
                  dataLabels: {
                      enabled: false
                  },
              },

          });
      }

      function styleTable(table) {

          Highcharts.css(table.querySelector('table'), {
              'border-collapse': 'collapse',
              'border-spacing': 0,
              'background': 'white',
              'min-width': '100%',
              'font-family': 'sans-serif',
              'font-size': '14px'
          });

          table.querySelectorAll('td, th, caption').forEach(function (elem) {
              Highcharts.css(elem, {
                  padding: '0.5em',
              });
          });

          Highcharts.css(table.querySelector('caption'), {
              'border-bottom': 'none',
              'font-size': '1.1em',
              'font-weight': 'bold'
          });

          table.querySelectorAll('caption, tr').forEach(function (elem, i) {
              if (i % 2) {
                  Highcharts.css(elem, {
                      background: '#f8f8f8'
                  });
              }
          });
      }

      function successGetReport(data, containerToDraw) {
          showReport(data, containerToDraw);
      }

      function errorGetReport(data) {
          console.log(data);
          console.log('error');
      }

      function getDataForReports(url, container) {
          getJson(url, [], function (data) {
              successGetReport(data, container)
          }, errorGetReport);
      }

      $(document).ready(function () {
          getDataForReports('/api/reportes/motivo', 'container1');
          getDataForReports('/api/reportes/genero', 'container2');
          getDataForReports('/api/reportes/localidad', 'container3');
      })

  </script>
{% endblock %}